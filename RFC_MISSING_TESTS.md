# RFC: Missing Test Coverage in pg-diff Compared to migra

## Executive Summary

This RFC identifies test coverage gaps in pg-diff compared to migra, a mature PostgreSQL schema diff tool. After analyzing migra's 25+ fixture-based test scenarios and our current 18 integration test files, several critical areas need additional test coverage to ensure pg-diff handles edge cases and complex scenarios properly.

## Analysis Overview

### Migra Test Structure
Migra uses a comprehensive fixture-based approach with 25+ test scenarios, each containing:
- `a.sql` - Initial schema state
- `b.sql` - Target schema state  
- `expected.sql` - Expected migration SQL
- `expected2.sql` - Expected SQL after additional changes
- `additions.sql` - Additional changes to test

### pg-diff Current Coverage
Our integration tests cover the basics well but miss several advanced scenarios that migra handles.

## Missing Test Coverage Areas

### 1. **Collations Support**
**Status**: ❌ **Missing**
**Priority**: Medium
**Migra Reference**: [`tests/FIXTURES/collations/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/collations)

**Missing Scenarios**:
- Creating/dropping collations
- Altering column collations
- Table column collation changes

**Suggested Implementation**:
- **File**: `tests/integration/collation-operations.test.ts`
- **Test Cases**:
  ```typescript
  test("create collation", async ({ db }) => {
    await roundtripFidelityTest({
      testSql: `CREATE COLLATION posix FROM "POSIX";`
    });
  });

  test("alter column collation", async ({ db }) => {
    await roundtripFidelityTest({
      initialSetup: `
        CREATE COLLATION posix FROM "POSIX";
        CREATE TABLE t(a text, b text collate posix);
      `,
      testSql: `
        CREATE COLLATION numeric (provider = icu, locale = 'en-u-kn-true');
        ALTER TABLE t ALTER COLUMN b SET DATA TYPE text COLLATE numeric;
      `
    });
  });
  ```

### 2. **Identity Columns (GENERATED ... AS IDENTITY)**
**Status**: ❌ **Missing** 
**Priority**: High
**Migra Reference**: [`tests/FIXTURES/identitycols/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/identitycols)

**Missing Scenarios**:
- `GENERATED ALWAYS AS IDENTITY` columns
- `GENERATED BY DEFAULT AS IDENTITY` columns
- Converting between identity types
- Adding/removing identity from columns

**Suggested Implementation**:
- **File**: `tests/integration/identity-columns.test.ts`
- **Test Cases**:
  ```typescript
  test("create table with identity columns", async ({ db }) => {
    await roundtripFidelityTest({
      testSql: `
        CREATE TABLE t(
          a int,
          b int default 1,
          c int generated always as (1) stored,
          d int generated always as identity,
          e int generated by default as identity
        );
      `
    });
  });

  test("convert identity column types", async ({ db }) => {
    await roundtripFidelityTest({
      initialSetup: `
        CREATE TABLE identchanges (
          d int generated always as identity,
          e int generated by default as identity
        );
      `,
      testSql: `
        ALTER TABLE identchanges ALTER COLUMN d SET GENERATED BY DEFAULT;
        ALTER TABLE identchanges ALTER COLUMN e SET GENERATED ALWAYS;
      `
    });
  });
  ```

### 3. **Generated Columns (STORED)**
**Status**: ❌ **Missing**
**Priority**: High  
**Migra Reference**: [`tests/FIXTURES/generated/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/generated)

**Missing Scenarios**:
- `GENERATED ALWAYS AS (...) STORED` columns
- Adding/removing generated expressions
- Modifying generated expressions

**Suggested Implementation**:
- **File**: `tests/integration/generated-columns.test.ts`
- **Test Cases**:
  ```typescript
  test("add generated column", async ({ db }) => {
    await roundtripFidelityTest({
      initialSetup: `CREATE TABLE t(id serial PRIMARY KEY);`,
      testSql: `
        ALTER TABLE t ADD COLUMN computed_val text 
        GENERATED ALWAYS AS ('computed_' || id::text) STORED;
      `
    });
  });

  test("drop generated expression", async ({ db }) => {
    await roundtripFidelityTest({
      initialSetup: `
        CREATE TABLE demo_gencol (
          id serial PRIMARY KEY,
          the_column TEXT GENERATED ALWAYS AS ('original value') STORED
        );
      `,
      testSql: `
        ALTER TABLE demo_gencol ALTER COLUMN the_column DROP EXPRESSION;
      `
    });
  });
  ```

### 4. **Table Inheritance**
**Status**: ❌ **Missing**
**Priority**: Medium
**Migra Reference**: [`tests/FIXTURES/inherit/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/inherit), [`tests/FIXTURES/inherit2/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/inherit2)

**Missing Scenarios**:
- Table inheritance with `INHERITS`
- Adding/removing inheritance relationships
- Complex inheritance hierarchies

**Suggested Implementation**:
- **File**: `tests/integration/table-inheritance.test.ts`
- **Test Cases**:
  ```typescript
  test("table inheritance", async ({ db }) => {
    await roundtripFidelityTest({
      testSql: `
        CREATE TABLE parent_table (id int, name text);
        CREATE TABLE child_table (age int) INHERITS (parent_table);
      `
    });
  });
  ```

### 5. **Extension Management**
**Status**: ⚠️ **Partial** 
**Priority**: Medium
**Migra Reference**: [`tests/FIXTURES/singleschema_ext/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/singleschema_ext), [`tests/FIXTURES/extversions/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/extversions)

**Missing Scenarios**:
- Extension version changes
- Extension-only migrations
- Extension dependency handling

**Suggested Implementation**:
- **File**: `tests/integration/extension-operations.test.ts`
- **Test Cases**:
  ```typescript
  test("extension version changes", async ({ db }) => {
    await roundtripFidelityTest({
      initialSetup: `CREATE EXTENSION pg_trgm VERSION '1.4';`,
      testSql: `ALTER EXTENSION pg_trgm UPDATE TO '1.5';`
    });
  });
  ```

### 6. **Privileges and Grants**
**Status**: ❌ **Missing**
**Priority**: High
**Migra Reference**: [`tests/FIXTURES/privileges/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/privileges)

**Missing Scenarios**:
- Table/view/function privileges
- GRANT/REVOKE operations
- Role-based permissions

**Suggested Implementation**:
- **File**: `tests/integration/privilege-operations.test.ts`
- **Test Cases**:
  ```typescript
  test("grant table privileges", async ({ db }) => {
    await roundtripFidelityTest({
      initialSetup: `CREATE TABLE any_table (id serial primary key, name text not null);`,
      testSql: `GRANT SELECT, INSERT ON TABLE any_table TO postgres;`
    });
  });

  test("revoke and change privileges", async ({ db }) => {
    await roundtripFidelityTest({
      initialSetup: `
        CREATE TABLE any_table (id serial primary key, name text not null);
        GRANT SELECT, INSERT ON TABLE any_table TO postgres;
      `,
      testSql: `
        REVOKE SELECT ON TABLE any_table FROM postgres;
        GRANT UPDATE ON TABLE any_table TO postgres;
      `
    });
  });
  ```

### 7. **Schema Filtering**
**Status**: ❌ **Missing**
**Priority**: Medium
**Migra Reference**: [`tests/FIXTURES/singleschema/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/singleschema), [`tests/FIXTURES/excludeschema/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/excludeschema)

**Missing Scenarios**:
- Single schema operations
- Schema exclusion patterns
- Cross-schema dependency handling

**Suggested Implementation**:
- **File**: `tests/integration/schema-filtering.test.ts`
- **Test Cases**:
  ```typescript
  test("single schema diff", async ({ db }) => {
    // Test diffing only specific schemas
  });

  test("exclude schema from diff", async ({ db }) => {
    // Test excluding certain schemas from comparison
  });
  ```

### 8. **Enum Type Edge Cases**
**Status**: ⚠️ **Partial**
**Priority**: High
**Migra Reference**: [`tests/FIXTURES/enumdefaults/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/enumdefaults), [`tests/FIXTURES/enumdeps/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/enumdeps)

**Missing Scenarios**:
- Enum values with defaults
- Complex enum dependency changes
- Enum type replacement with value changes

**Suggested Implementation**:
- **File**: Extend `tests/integration/type-operations.test.ts`
- **Test Cases**:
  ```typescript
  test("enum with default values", async ({ db }) => {
    await roundtripFidelityTest({
      testSql: `
        CREATE TYPE order_status AS ENUM('pending', 'processing', 'complete');
        CREATE TABLE orders(
          id serial primary key,
          status order_status default 'pending'::order_status
        );
      `
    });
  });

  test("enum value addition with default handling", async ({ db }) => {
    await roundtripFidelityTest({
      initialSetup: `
        CREATE TYPE order_status AS ENUM('pending', 'processing', 'complete');
        CREATE TABLE orders(
          id serial primary key,
          status order_status default 'pending'::order_status
        );
      `,
      testSql: `
        -- Should handle the complex enum replacement pattern
        ALTER TABLE orders ALTER COLUMN status DROP DEFAULT;
        ALTER TYPE order_status RENAME TO order_status__old_version_to_be_dropped;
        CREATE TYPE order_status AS ENUM('pending', 'processing', 'complete', 'rejected');
        ALTER TABLE orders ALTER COLUMN status TYPE order_status USING status::text::order_status;
        ALTER TABLE orders ALTER COLUMN status SET DEFAULT 'pending'::order_status;
        DROP TYPE order_status__old_version_to_be_dropped;
      `
    });
  });
  ```

### 9. **Complex Dependency Scenarios**
**Status**: ⚠️ **Partial**
**Priority**: High
**Migra Reference**: [`tests/FIXTURES/dependencies/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/dependencies), [`tests/FIXTURES/dependencies2/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/dependencies2), [`tests/FIXTURES/dependencies3/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/dependencies3), [`tests/FIXTURES/dependencies4/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/dependencies4)

**Missing Scenarios**:
- Multiple dependency chain scenarios
- Circular dependency resolution
- Cross-schema dependencies

**Suggested Implementation**:
- **File**: Extend `tests/integration/complex-dependency-ordering.test.ts`
- **Additional Test Cases**: Add more complex scenarios based on migra's dependencies fixtures

### 10. **Comprehensive Integration Test**
**Status**: ❌ **Missing**
**Priority**: Medium
**Migra Reference**: [`tests/FIXTURES/everything/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/everything)

**Missing Scenarios**:
- All-in-one comprehensive schema changes
- Mixed object type operations
- Real-world complexity simulation

**Suggested Implementation**:
- **File**: `tests/integration/comprehensive-schema.test.ts`
- **Test Cases**: Based on migra's "everything" fixture covering multiple object types in one test

## Implementation Priority

### High Priority (Critical for Production)
1. **Identity Columns** - Common in modern PostgreSQL usage
2. **Generated Columns** - Frequently used for computed values  
3. **Privileges and Grants** - Essential for security
4. **Enum Edge Cases** - Complex but common scenarios

### Medium Priority (Important for Completeness)
1. **Collations** - Important for internationalization
2. **Table Inheritance** - Less common but complex when used
3. **Extension Management** - Important for PostgreSQL ecosystems
4. **Schema Filtering** - Useful for large applications

### Low Priority (Nice to Have)
1. **Comprehensive Integration** - Good for regression testing

## Estimated Implementation Effort

- **High Priority Items**: ~2-3 weeks of development
- **Medium Priority Items**: ~1-2 weeks of development  
- **Low Priority Items**: ~1 week of development

**Total Estimated Effort**: 4-6 weeks for complete coverage

## Conclusion

Implementing these missing test cases will significantly improve pg-diff's robustness and ensure it handles the same complex scenarios that migra supports. The fixture-based approach used by migra provides excellent examples for our roundtrip fidelity tests.

Priority should be given to identity columns, generated columns, and privilege management as these are commonly used features in production PostgreSQL databases.
