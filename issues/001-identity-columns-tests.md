# Issue #001: Add Identity Columns Test Coverage

## Priority: ðŸ”´ High

## Description
Add comprehensive test coverage for PostgreSQL identity columns (`GENERATED ALWAYS AS IDENTITY` and `GENERATED BY DEFAULT AS IDENTITY`). This is a commonly used feature in modern PostgreSQL databases but currently lacks test coverage in pg-diff.

## Reference
- **Migra fixture**: [`tests/FIXTURES/identitycols/`](https://github.com/djrobstep/migra/tree/master/tests/FIXTURES/identitycols)
- **Migra test examples**: [a.sql](https://github.com/djrobstep/migra/blob/main/tests/FIXTURES/identitycols/a.sql), [b.sql](https://github.com/djrobstep/migra/blob/main/tests/FIXTURES/identitycols/b.sql), [expected.sql](https://github.com/djrobstep/migra/blob/main/tests/FIXTURES/identitycols/expected.sql)

## Missing Test Scenarios

### 1. Create table with identity columns
```sql
CREATE TABLE t(
    a int,
    b int default 1,
    c int generated always as (1) stored,
    d int generated always as identity,
    e int generated by default as identity
);
```

### 2. Convert between identity types
```sql
-- Convert ALWAYS to BY DEFAULT
ALTER TABLE identchanges ALTER COLUMN d SET GENERATED BY DEFAULT;
-- Convert BY DEFAULT to ALWAYS  
ALTER TABLE identchanges ALTER COLUMN e SET GENERATED ALWAYS;
```

### 3. Add/remove identity from columns
```sql
-- Add identity to regular column
ALTER TABLE identchanges ALTER COLUMN c ADD GENERATED BY DEFAULT AS IDENTITY;
-- Remove identity from column
ALTER TABLE identchanges ALTER COLUMN f DROP IDENTITY;
```

### 4. Identity column with NOT NULL handling
```sql
-- Identity columns should automatically be NOT NULL
-- Test the proper handling of NOT NULL when adding/removing identity
```

## Implementation Plan

### File Location
- **New file**: `tests/integration/identity-columns.test.ts`

### Test Structure
```typescript
/**
 * Integration tests for PostgreSQL identity column operations.
 */

import { describe } from "vitest";
import { POSTGRES_VERSIONS } from "../constants.ts";
import { getTest } from "../utils.ts";
import { roundtripFidelityTest } from "./roundtrip.ts";

for (const pgVersion of POSTGRES_VERSIONS) {
  const test = getTest(pgVersion);

  describe.concurrent(`identity column operations (pg${pgVersion})`, () => {
    test("create table with identity columns", async ({ db }) => {
      await roundtripFidelityTest({
        mainSession: db.main,
        branchSession: db.branch,
        initialSetup: "CREATE SCHEMA test_schema;",
        testSql: `
          CREATE TABLE test_schema.identity_test (
            a int,
            b int default 1,
            c int generated always as (1) stored,
            d int generated always as identity,
            e int generated by default as identity
          );
        `,
      });
    });

    test("convert identity column types", async ({ db }) => {
      await roundtripFidelityTest({
        mainSession: db.main,
        branchSession: db.branch,
        initialSetup: `
          CREATE SCHEMA test_schema;
          CREATE TABLE test_schema.identchanges (
            c int default 77,
            d int generated always as identity,
            e int generated by default as identity,
            f int generated always as identity
          );
        `,
        testSql: `
          ALTER TABLE test_schema.identchanges ALTER COLUMN c DROP DEFAULT;
          ALTER TABLE test_schema.identchanges ALTER COLUMN c SET NOT NULL;
          ALTER TABLE test_schema.identchanges ALTER COLUMN c ADD GENERATED BY DEFAULT AS IDENTITY;
          ALTER TABLE test_schema.identchanges ALTER COLUMN d SET GENERATED BY DEFAULT;
          ALTER TABLE test_schema.identchanges ALTER COLUMN e SET GENERATED ALWAYS;
          ALTER TABLE test_schema.identchanges ALTER COLUMN f DROP IDENTITY;
          ALTER TABLE test_schema.identchanges ALTER COLUMN f DROP NOT NULL;
        `,
      });
    });

    test("drop and recreate table with identity changes", async ({ db }) => {
      await roundtripFidelityTest({
        mainSession: db.main,
        branchSession: db.branch,
        initialSetup: `
          CREATE SCHEMA test_schema;
          CREATE TABLE test_schema.t (
            a int,
            b int default 1,
            c int generated always as (1) stored,
            d int generated always as identity,
            e int generated by default as identity
          );
        `,
        testSql: `
          DROP TABLE test_schema.t;
          CREATE TABLE test_schema.t2 (
            a int,
            b int default 1,
            c int generated always as (1) stored,
            d int generated always as identity,
            e int generated by default as identity
          );
        `,
      });
    });
  });
}
```

## Expected Behavior
- pg-diff should correctly detect identity column creation, modification, and removal
- Should handle the complex `ALTER COLUMN ... ADD/DROP/SET GENERATED` syntax
- Should properly manage NOT NULL constraints that are implicit with identity columns
- Should generate correct migration SQL that matches migra's output

## Acceptance Criteria
- [ ] All test cases pass for all supported PostgreSQL versions
- [ ] Test covers identity column creation, modification, and removal
- [ ] Test covers conversion between `ALWAYS` and `BY DEFAULT` identity types
- [ ] Test covers adding/removing identity from existing columns
- [ ] Test handles NOT NULL constraint implications correctly
- [ ] Generated migration SQL is syntactically correct and functionally equivalent to migra

## Estimated Effort
**2-3 days** - Moderate complexity due to identity column edge cases and NOT NULL handling.
